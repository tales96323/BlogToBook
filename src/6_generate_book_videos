import json
import re

def limpar_titulo(titulo):
    """Remove o prefixo [Akitando] #... - dos títulos"""
    return re.sub(r'^\[Akitando\] #\d+ - ', '', titulo).strip()

def gerar_livro_didatico():
    # Carregar dados
    with open('videos_filtrados.json', 'r', encoding='utf-8') as f:
        videos = json.load(f)
    
    # Criar dicionário de mapeamento (título limpo -> vídeo completo)
    mapa_videos = {}
    for video in videos:
        titulo_limpo = limpar_titulo(video['titulo'])
        video['titulo_limpo'] = titulo_limpo  # Mantém versão limpa para referência
        mapa_videos[titulo_limpo] = video

    # Processar estrutura de capítulos
    estrutura_capitulos = {}
    with open('capitulos.txt', 'r', encoding='utf-8') as f:
        for linha in f:
            partes = linha.strip().split(' - ', 1)
            if len(partes) == 2:
                capitulo, titulo_video = partes
                titulo_video_limpo = limpar_titulo(titulo_video)
                
                if capitulo not in estrutura_capitulos:
                    estrutura_capitulos[capitulo] = []
                
                if titulo_video_limpo in mapa_videos:
                    estrutura_capitulos[capitulo].append(mapa_videos[titulo_video_limpo])
                    del mapa_videos[titulo_video_limpo]

    # Gerar conteúdo formatado
    conteudo = []
    for capitulo, videos in estrutura_capitulos.items():
        conteudo.append(f"\n\n=== {capitulo.upper()} ===")
        
        for idx, video in enumerate(videos, 1):
            conteudo.append(f"\nAula {idx}: {video['titulo_limpo']}")
            conteudo.append(f"Data: {video['data']}")
            conteudo.append(f"Conteúdo: {video['container']}")
            conteudo.append(f"Link: {video['texts href']}")
            conteudo.append(f"Tags: {video['tag']}")
            conteudo.append("-" * 50)

    # Adicionar vídeos não catalogados
    if mapa_videos:
        conteudo.append("\n\n=== CONTEÚDO NÃO CATALOGADO ===")
        for video in mapa_videos.values():
            conteudo.append(f"\nTítulo: {video['titulo_limpo']}")
            conteudo.append(f"Data: {video['data']}")
            conteudo.append(f"Conteúdo: {video['container']}")
            conteudo.append(f"Link: {video['texts href']}")
            conteudo.append(f"Tags: {video['tag']}")
            conteudo.append("-" * 50)

    # Salvar arquivo
    with open('livro_didatico.txt', 'w', encoding='utf-8') as f:
        f.write('\n'.join(conteudo))

    print("Livro didático gerado com sucesso!")

if __name__ == '__main__':
    gerar_livro_didatico()